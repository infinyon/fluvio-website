name: Test client examples

permissions:
  contents: read

concurrency:
  group: examples-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - staging
      - trying
  pull_request:
    branches: [master]
  workflow_dispatch:

env:
  K3D_VERSION: v5.4.1

jobs:
  examples:
    name: Run all client examples
    runs-on: ubuntu-latest
    strategy:
      matrix:
        client-type:
          - rust
          - python
          - node
          - java

    steps:
      - uses: actions/checkout@v3

      - uses: actions/checkout@v3
        with:
          repository: infinyon/fluvio
          path: fluvio-repo
      - name: Setup K3d
        run: curl -s https://raw.githubusercontent.com/rancher/k3d/main/install.sh | TAG=${{ env.K3D_VERSION }} bash
      - name: Create K3d cluster
        run: |
          ./fluvio-repo/k8-util/cluster/reset-k3d.sh

      - name: Sleep 20 to ensure k3d cluster is ready
        run: sleep 20
      - name: Install Fluvio Local Cluster
        uses: infinyon/fluvio@master
        with:
          cluster-type: local
          version: latest

      # Ensure cluster is started
      - name: Ensure Fluvio Cluster is up
        run: |
          make cluster-verify

      # Run docker build
      - name: Build and test clients
        run: |
          make run-client-example-${{ matrix.client-type }}
